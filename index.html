<!doctype html>
<html lang="fa" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پاترونوس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; }
    * { font-family: 'Vazirmatn', system-ui, sans-serif; }
    
    .chat-bubble-sent {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 18px 18px 4px 18px;
    }
    .chat-bubble-received {
      background: #374151;
      border-radius: 18px 18px 18px 4px;
    }
    
    .sidebar-item:hover { background: rgba(99, 102, 241, 0.1); }
    .sidebar-item.active { background: rgba(99, 102, 241, 0.2); border-right: 3px solid #6366f1; }
    
    .online-dot { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .message-enter { animation: slideIn 0.3s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .typing-indicator span {
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    
    .glass-effect {
      background: rgba(17, 24, 39, 0.8);
      backdrop-filter: blur(12px);
    }
    
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
    }
    
    .fab-button {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    .fab-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-900 text-white overflow-hidden"><!-- Login Page -->
  <div id="loginPage" class="h-full flex items-center justify-center p-4">
   <div class="w-full max-w-md">
    <div class="text-center mb-8">
     <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30">
      <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
     </div>
     <h1 id="appTitle" class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">پاترونوس</h1>
     <p class="text-gray-400 mt-2">پیام‌رسان امن و سریع</p>
    </div>
    <div class="glass-effect rounded-2xl p-6 shadow-xl">
     <div id="loginForm">
      <div class="mb-4"><label for="loginUserid" class="block text-sm text-gray-400 mb-2">نام کاربری یا شناسه</label> <input type="text" id="loginUserid" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="username یا userid">
      </div>
      <div class="mb-6"><label for="loginPassword" class="block text-sm text-gray-400 mb-2">رمز عبور</label> <input type="password" id="loginPassword" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="••••••••">
      </div><button onclick="handleLogin()" class="w-full fab-button text-white font-semibold py-3 rounded-xl transition-all duration-300"> ورود </button>
      <div id="loginError" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400 text-sm text-center"></div>
      <div id="loginLoading" class="hidden mt-4 text-center text-gray-400">
       <svg class="animate-spin h-6 w-6 mx-auto text-indigo-500" fill="none" viewbox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
       </svg>
      </div>
     </div>
     <div class="mt-6 text-center"><span class="text-gray-400">حساب ندارید؟</span> <button onclick="showRegister()" class="text-indigo-400 hover:text-indigo-300 mr-1 font-medium">ثبت‌نام کنید</button>
     </div>
    </div>
   </div>
  </div><!-- Register Page -->
  <div id="registerPage" class="hidden h-full flex items-center justify-center p-4">
   <div class="w-full max-w-md">
    <div class="text-center mb-6">
     <h2 class="text-2xl font-bold text-white">ثبت‌نام در پاترونوس</h2>
     <p class="text-gray-400 mt-1">یک حساب جدید بسازید</p>
    </div>
    <div class="glass-effect rounded-2xl p-6 shadow-xl">
     <div class="mb-4"><label for="regUsername" class="block text-sm text-gray-400 mb-2">نام کاربری</label> <input type="text" id="regUsername" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="مثال: ali_123">
     </div>
     <div class="mb-4"><label for="regUserid" class="block text-sm text-gray-400 mb-2">شناسه یکتا (userid)</label> <input type="text" id="regUserid" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="مثال: ali2024">
     </div>
     <div class="mb-4"><label for="regPassword" class="block text-sm text-gray-400 mb-2">رمز عبور</label> <input type="password" id="regPassword" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="حداقل ۴ کاراکتر">
     </div>
     <div class="mb-6"><label for="regPhone" class="block text-sm text-gray-400 mb-2">شماره تلفن (اختیاری)</label> <input type="text" id="regPhone" class="w-full bg-gray-800 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 input-glow focus:border-indigo-500 focus:outline-none transition" placeholder="09123456789">
     </div><button onclick="handleRegister()" class="w-full fab-button text-white font-semibold py-3 rounded-xl transition-all duration-300"> ثبت‌نام </button>
     <div id="regError" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-xl text-red-400 text-sm text-center"></div>
     <div id="regSuccess" class="hidden mt-4 p-3 bg-green-500/20 border border-green-500/50 rounded-xl text-green-400 text-sm text-center"></div>
     <div id="regLoading" class="hidden mt-4 text-center">
      <svg class="animate-spin h-6 w-6 mx-auto text-indigo-500" fill="none" viewbox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
      </svg>
     </div>
     <div class="mt-6 text-center"><span class="text-gray-400">حساب دارید؟</span> <button onclick="showLogin()" class="text-indigo-400 hover:text-indigo-300 mr-1 font-medium">وارد شوید</button>
     </div>
    </div>
   </div>
  </div><!-- Main Chat App -->
  <div id="mainApp" class="hidden h-full flex"><!-- Sidebar -->
   <aside id="sidebar" class="w-80 bg-gray-800/50 border-l border-gray-700 flex flex-col h-full"><!-- User Header -->
    <header class="p-4 border-b border-gray-700 glass-effect">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold"><span id="userAvatar">U</span>
       </div>
       <div>
        <p id="userName" class="font-semibold text-white">کاربر</p>
        <p class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-400 rounded-full online-dot"></span> آنلاین</p>
       </div>
      </div>
      <div class="flex gap-2"><button onclick="showNewChatModal()" class="p-2 hover:bg-gray-700 rounded-lg transition" title="چت جدید">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg></button> <button onclick="logout()" class="p-2 hover:bg-gray-700 rounded-lg transition" title="خروج">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg></button>
      </div>
     </div>
    </header><!-- Search -->
    <div class="p-3">
     <div class="relative"><label for="searchInput" class="sr-only">جستجو</label> <input type="text" id="searchInput" onkeyup="filterChats()" class="w-full bg-gray-700/50 border border-gray-600 rounded-xl px-4 py-2 pr-10 text-white placeholder-gray-400 text-sm focus:border-indigo-500 focus:outline-none" placeholder="جستجو...">
      <svg class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
     </div>
    </div><!-- Tabs -->
    <nav class="flex border-b border-gray-700 px-2"><button onclick="switchTab('chats')" id="tabChats" class="flex-1 py-2 text-sm font-medium text-indigo-400 border-b-2 border-indigo-400">چت‌ها</button> <button onclick="switchTab('groups')" id="tabGroups" class="flex-1 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">گروه‌ها</button> <button onclick="switchTab('channels')" id="tabChannels" class="flex-1 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">کانال‌ها</button>
    </nav><!-- Chat List -->
    <div id="chatList" class="flex-1 overflow-y-auto scrollbar-thin">
     <div id="chatsContainer" class="p-2 space-y-1"></div>
     <div id="groupsContainer" class="hidden p-2 space-y-1"></div>
     <div id="channelsContainer" class="hidden p-2 space-y-1"></div>
    </div>
   </aside><!-- Chat Area -->
   <main class="flex-1 flex flex-col h-full bg-gray-900"><!-- Empty State -->
    <div id="emptyState" class="flex-1 flex items-center justify-center">
     <div class="text-center">
      <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-gray-800 flex items-center justify-center">
       <svg class="w-16 h-16 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
       </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-400 mb-2">به پاترونوس خوش آمدید!</h3>
      <p class="text-gray-500">یک چت را انتخاب کنید یا گفتگوی جدید شروع کنید</p>
     </div>
    </div><!-- Chat View -->
    <div id="chatView" class="hidden flex-1 flex flex-col h-full"><!-- Chat Header -->
     <header class="p-4 border-b border-gray-700 glass-effect flex items-center justify-between">
      <div class="flex items-center gap-3"><button onclick="closeChatMobile()" class="md:hidden p-2 hover:bg-gray-700 rounded-lg">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg></button>
       <div id="chatAvatar" class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
        U
       </div>
       <div>
        <p id="chatName" class="font-semibold text-white">نام چت</p>
        <p id="chatStatus" class="text-xs text-gray-400">آخرین بازدید</p>
       </div>
      </div>
      <div class="flex gap-2"><button class="p-2 hover:bg-gray-700 rounded-lg transition" title="تماس">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
        </svg></button> <button class="p-2 hover:bg-gray-700 rounded-lg transition" title="بیشتر">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
        </svg></button>
      </div>
     </header><!-- Messages -->
     <div id="messagesContainer" class="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-3"><!-- Messages will be rendered here -->
     </div><!-- Typing Indicator -->
     <div id="typingIndicator" class="hidden px-4 py-2">
      <div class="flex items-center gap-2 text-gray-400 text-sm">
       <div class="typing-indicator flex gap-1"><span class="w-2 h-2 bg-gray-400 rounded-full"></span> <span class="w-2 h-2 bg-gray-400 rounded-full"></span> <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
       </div><span>در حال نوشتن...</span>
      </div>
     </div><!-- Message Input -->
     <footer class="p-4 border-t border-gray-700 glass-effect">
      <div class="flex items-end gap-3"><button class="p-2 hover:bg-gray-700 rounded-lg transition" title="پیوست">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
        </svg></button>
       <div class="flex-1 relative"><label for="messageInput" class="sr-only">پیام</label> <textarea id="messageInput" onkeydown="handleMessageKeydown(event)" rows="1" class="w-full bg-gray-700/50 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 resize-none focus:border-indigo-500 focus:outline-none" placeholder="پیام بنویسید..." style="max-height: 120px;"></textarea>
       </div><button class="p-2 hover:bg-gray-700 rounded-lg transition" title="ایموجی">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg></button> <button onclick="sendMessageHandler()" class="fab-button p-3 rounded-xl transition-all duration-300" title="ارسال">
        <svg class="w-5 h-5 text-white transform rotate-180" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
        </svg></button>
      </div>
     </footer>
    </div>
   </main>
  </div><!-- New Chat Modal -->
  <div id="newChatModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
   <div class="bg-gray-800 rounded-2xl w-full max-w-md max-h-[80%] flex flex-col shadow-2xl">
    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
     <h3 class="text-lg font-semibold text-white">چت جدید</h3><button onclick="closeNewChatModal()" class="p-2 hover:bg-gray-700 rounded-lg">
      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg></button>
    </div><!-- Tabs for new chat/group/channel -->
    <div class="flex border-b border-gray-700"><button onclick="switchNewTab('user')" id="newTabUser" class="flex-1 py-3 text-sm font-medium text-indigo-400 border-b-2 border-indigo-400">کاربر</button> <button onclick="switchNewTab('group')" id="newTabGroup" class="flex-1 py-3 text-sm font-medium text-gray-400 border-b-2 border-transparent">گروه جدید</button> <button onclick="switchNewTab('channel')" id="newTabChannel" class="flex-1 py-3 text-sm font-medium text-gray-400 border-b-2 border-transparent">کانال جدید</button>
    </div><!-- User Search -->
    <div id="newUserPanel" class="flex-1 overflow-hidden flex flex-col">
     <div class="p-3"><label for="userSearchInput" class="sr-only">جستجوی کاربر</label> <input type="text" id="userSearchInput" onkeyup="searchUsers()" class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-white placeholder-gray-400 text-sm focus:border-indigo-500 focus:outline-none" placeholder="جستجوی کاربر...">
     </div>
     <div id="usersList" class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-1">
      <div class="text-center text-gray-400 py-8">
       در حال بارگذاری...
      </div>
     </div>
    </div><!-- New Group -->
    <div id="newGroupPanel" class="hidden flex-1 overflow-hidden flex flex-col p-4">
     <div class="space-y-4">
      <div><label for="newGroupName" class="block text-sm text-gray-400 mb-2">نام گروه</label> <input type="text" id="newGroupName" class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-white placeholder-gray-400 focus:border-indigo-500 focus:outline-none" placeholder="نام گروه را وارد کنید">
      </div>
      <div><label for="newGroupBio" class="block text-sm text-gray-400 mb-2">توضیحات (اختیاری)</label> <textarea id="newGroupBio" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-2 text-white placeholder-gray-400 resize-none focus:border-indigo-500 focus:outline-none" placeholder="توضیحات گروه"></textarea>
      </div><button onclick="createNewGroup()" class="w-full fab-button text-white font-semibold py-3 rounded-xl">ساخت گروه</button>
     </div>
    </div><!-- New Channel -->
    <div id="newChannelPanel" class="hidden flex-1 overflow-hidden flex flex-col p-4">
     <div class="space-y-4">
      <div><label for="newChannelName" class="block text-sm text-gray-400 mb-2">نام کانال</label> <input type="text" id="newChannelName" class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 focus:border-indigo-500 focus:outline-none" placeholder="نام کانال را وارد کنید">
      </div>
      <div><label for="newChannelBio" class="block text-sm text-gray-400 mb-2">توضیحات (اختیاری)</label> <textarea id="newChannelBio" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-400 resize-none focus:border-indigo-500 focus:outline-none" placeholder="توضیحات کانال"></textarea>
      </div><button onclick="createNewChannel()" class="w-full fab-button text-white font-semibold py-3 rounded-xl">ساخت کانال</button>
     </div>
    </div>
   </div>
  </div><!-- Toast Notification -->
  <div id="toast" class="hidden fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-xl z-50 transition-all duration-300">
   <div class="flex items-center gap-3">
    <div id="toastIcon" class="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center">
     <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
     </svg>
    </div>
    <p id="toastMessage" class="text-white text-sm flex-1"></p>
   </div>
  </div>
  <script>
  // ===================== CONFIG & STATE =====================
  const API_URL = 'https://script.google.com/macros/s/AKfycbx58pC2wvnCrM4a_3XeIESwR1lW_Wn7Qcw7J6jtOXozGITO3JLu4tTzFUE_iBUQxoPh/exec';
  
  let currentUser = null;
  let currentChat = null;
  let allUsers = [];
  let allChats = [];
  let allGroups = [];
  let allChannels = [];
  let currentMessages = [];
  let pollInterval = null;
  
  const defaultConfig = {
    app_title: 'پاترونوس'
  };
  
  // ===================== ELEMENT SDK =====================
  if (window.elementSdk) {
    window.elementSdk.init({
      defaultConfig,
      onConfigChange: async (config) => {
        const title = config.app_title || defaultConfig.app_title;
        document.getElementById('appTitle').textContent = title;
        document.title = title;
      },
      mapToCapabilities: (config) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (config) => new Map([
        ['app_title', config.app_title || defaultConfig.app_title]
      ])
    });
  }
  
  // ===================== API HELPERS =====================
  async function apiCall(payload) {
    try {
      // Use text/plain to avoid CORS preflight
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 
          'Content-Type': 'text/plain;charset=utf-8'
        },
        body: JSON.stringify(payload),
        redirect: 'follow'
      });
      
      const text = await response.text();
      
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error('JSON Parse Error:', text);
        return { ok: false, error: 'پاسخ نامعتبر از سرور' };
      }
    } catch (error) {
      console.error('API Error:', error);
      return { ok: false, error: 'خطا در اتصال به سرور: ' + error.message };
    }
  }
  
  // ===================== TOAST =====================
  function showToast(message, isError = false) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    toastMessage.textContent = message;
    
    if (isError) {
      toastIcon.innerHTML = '<svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
      toastIcon.className = 'w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center';
    } else {
      toastIcon.innerHTML = '<svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
      toastIcon.className = 'w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center';
    }
    
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }
  
  // ===================== AUTH =====================
  function showLogin() {
    document.getElementById('registerPage').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
  }
  
  function showRegister() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('registerPage').classList.remove('hidden');
  }
  
  async function handleLogin() {
    const userid = document.getElementById('loginUserid').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!userid || !password) {
      document.getElementById('loginError').textContent = 'لطفاً تمام فیلدها را پر کنید';
      document.getElementById('loginError').classList.remove('hidden');
      return;
    }
    
    document.getElementById('loginError').classList.add('hidden');
    document.getElementById('loginLoading').classList.remove('hidden');
    
    const result = await apiCall({
      action: 'login',
      userid: userid,
      password: password
    });
    
    document.getElementById('loginLoading').classList.add('hidden');
    
    if (result.ok) {
      currentUser = result.user;
      localStorage.setItem('patronus_user', JSON.stringify(currentUser));
      showMainApp();
    } else {
      document.getElementById('loginError').textContent = result.error || 'خطا در ورود';
      document.getElementById('loginError').classList.remove('hidden');
    }
  }
  
  async function handleRegister() {
    const username = document.getElementById('regUsername').value.trim();
    const userid = document.getElementById('regUserid').value.trim();
    const password = document.getElementById('regPassword').value;
    const phone = document.getElementById('regPhone').value.trim();
    
    if (!username || !userid || !password) {
      document.getElementById('regError').textContent = 'لطفاً فیلدهای ضروری را پر کنید';
      document.getElementById('regError').classList.remove('hidden');
      return;
    }
    
    if (password.length < 4) {
      document.getElementById('regError').textContent = 'رمز عبور باید حداقل ۴ کاراکتر باشد';
      document.getElementById('regError').classList.remove('hidden');
      return;
    }
    
    document.getElementById('regError').classList.add('hidden');
    document.getElementById('regSuccess').classList.add('hidden');
    document.getElementById('regLoading').classList.remove('hidden');
    
    const result = await apiCall({
      action: 'register',
      username: username,
      userid: userid,
      password: password,
      phone: phone
    });
    
    document.getElementById('regLoading').classList.add('hidden');
    
    if (result.ok) {
      document.getElementById('regSuccess').textContent = 'ثبت‌نام موفق! اکنون وارد شوید';
      document.getElementById('regSuccess').classList.remove('hidden');
      setTimeout(() => showLogin(), 2000);
    } else {
      document.getElementById('regError').textContent = result.error || 'خطا در ثبت‌نام';
      document.getElementById('regError').classList.remove('hidden');
    }
  }
  
  function logout() {
    currentUser = null;
    currentChat = null;
    localStorage.removeItem('patronus_user');
    if (pollInterval) clearInterval(pollInterval);
    
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('loginUserid').value = '';
    document.getElementById('loginPassword').value = '';
  }
  
  // ===================== MAIN APP =====================
  async function showMainApp() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('registerPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Update user info
    document.getElementById('userName').textContent = currentUser.username;
    document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
    
    // Load data
    await loadUsers();
    await loadChats();
    await loadGroups();
    await loadChannels();
    
    // Start polling for new messages
    startPolling();
  }
  
  // ===================== DATA LOADING =====================
  async function loadUsers() {
    const result = await apiCall({ action: 'getUsers' });
    if (result.ok) {
      allUsers = result.users.filter(u => u.userid !== currentUser.userid);
    }
  }
  
  async function loadChats() {
    const result = await apiCall({ action: 'getChats', oderId: currentUser.userid });
    if (result.ok) {
      allChats = result.chats || [];
      renderChatList();
    }
  }
  
  async function loadGroups() {
    allGroups = [];
    renderGroupList();
  }
  
  async function loadChannels() {
    allChannels = [];
    renderChannelList();
  }
  
  // ===================== CHAT LIST RENDERING =====================
  function renderChatList() {
    const container = document.getElementById('chatsContainer');
    
    if (allChats.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>هیچ چتی ندارید</p>
          <p class="text-sm mt-1">روی + کلیک کنید تا چت جدید شروع کنید</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = allChats.map(chat => {
      const otherUserId = chat.participants.find(p => p !== currentUser.userid);
      const otherUser = allUsers.find(u => u.userid === otherUserId) || { username: otherUserId };
      const initial = (otherUser.username || 'U').charAt(0).toUpperCase();
      const isActive = currentChat && currentChat.id === chat.id;
      
      return `
        <div onclick="openChat('${chat.id}')" class="sidebar-item ${isActive ? 'active' : ''} flex items-center gap-3 p-3 rounded-xl cursor-pointer transition">
          <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold flex-shrink-0">
            ${initial}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <p class="font-medium text-white truncate">${otherUser.username}</p>
              <span class="text-xs text-gray-500">${formatTime(chat.lastMessageTime)}</span>
            </div>
            <p class="text-sm text-gray-400 truncate">${chat.lastMessage || 'پیامی نیست'}</p>
          </div>
          ${chat.unread > 0 ? `<span class="w-5 h-5 rounded-full bg-indigo-500 text-white text-xs flex items-center justify-center">${chat.unread}</span>` : ''}
        </div>
      `;
    }).join('');
  }
  
  function renderGroupList() {
    const container = document.getElementById('groupsContainer');
    
    if (allGroups.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>هیچ گروهی ندارید</p>
          <p class="text-sm mt-1">روی + کلیک کنید تا گروه جدید بسازید</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = allGroups.map(group => `
      <div onclick="openGroup('${group.id}')" class="sidebar-item flex items-center gap-3 p-3 rounded-xl cursor-pointer transition">
        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-medium text-white truncate">${group.name}</p>
          <p class="text-sm text-gray-400 truncate">${group.lastMessage || 'پیامی نیست'}</p>
        </div>
      </div>
    `).join('');
  }
  
  function renderChannelList() {
    const container = document.getElementById('channelsContainer');
    
    if (allChannels.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>هیچ کانالی ندارید</p>
          <p class="text-sm mt-1">روی + کلیک کنید تا کانال جدید بسازید</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = allChannels.map(channel => `
      <div onclick="openChannel('${channel.id}')" class="sidebar-item flex items-center gap-3 p-3 rounded-xl cursor-pointer transition">
        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-pink-600 flex items-center justify-center text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <p class="font-medium text-white truncate">${channel.name}</p>
          <p class="text-sm text-gray-400 truncate">${channel.lastMessage || 'پیامی نیست'}</p>
        </div>
      </div>
    `).join('');
  }
  
  // ===================== TABS =====================
  function switchTab(tab) {
    const tabs = ['chats', 'groups', 'channels'];
    tabs.forEach(t => {
      document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.remove('text-indigo-400', 'border-indigo-400');
      document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.add('text-gray-400', 'border-transparent');
      document.getElementById(`${t}Container`).classList.add('hidden');
    });
    
    document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('text-indigo-400', 'border-indigo-400');
    document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('text-gray-400', 'border-transparent');
    document.getElementById(`${tab}Container`).classList.remove('hidden');
  }
  
  // ===================== CHAT OPERATIONS =====================
  async function openChat(chatId) {
    const chat = allChats.find(c => c.id === chatId);
    if (!chat) return;
    
    currentChat = chat;
    
    const otherUserId = chat.participants.find(p => p !== currentUser.userid);
    const otherUser = allUsers.find(u => u.userid === otherUserId) || { username: otherUserId };
    
    document.getElementById('chatName').textContent = otherUser.username;
    document.getElementById('chatAvatar').textContent = (otherUser.username || 'U').charAt(0).toUpperCase();
    document.getElementById('chatStatus').textContent = otherUser.online ? 'آنلاین' : 'آفلاین';
    
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('chatView').classList.remove('hidden');
    
    // Load messages
    await loadMessages(chatId);
    
    // Update sidebar active state
    renderChatList();
  }
  
  async function loadMessages(chatId) {
    const container = document.getElementById('messagesContainer');
    container.innerHTML = '<div class="text-center py-4 text-gray-400">در حال بارگذاری پیام‌ها...</div>';
    
    const result = await apiCall({ action: 'getMessages', chatId: chatId });
    
    if (result.ok) {
      currentMessages = result.messages || [];
      renderMessages();
    } else {
      container.innerHTML = '<div class="text-center py-4 text-red-400">خطا در بارگذاری پیام‌ها</div>';
    }
  }
  
  function renderMessages() {
    const container = document.getElementById('messagesContainer');
    
    if (currentMessages.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <p>هیچ پیامی نیست</p>
          <p class="text-sm mt-1">اولین پیام را ارسال کنید!</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = currentMessages.map(msg => {
      const isMine = msg.senderId === currentUser.userid;
      const time = formatTime(msg.timestamp);
      
      return `
        <div class="flex ${isMine ? 'justify-start' : 'justify-end'} message-enter">
          <div class="${isMine ? 'chat-bubble-sent' : 'chat-bubble-received'} px-4 py-2 max-w-xs md:max-w-md lg:max-w-lg">
            <p class="text-white whitespace-pre-wrap break-words">${escapeHtml(msg.text)}</p>
            <div class="flex items-center justify-end gap-1 mt-1">
              <span class="text-xs ${isMine ? 'text-indigo-200' : 'text-gray-400'}">${time}</span>
              ${isMine ? `
                <svg class="w-4 h-4 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }
  
  // ===================== SEND MESSAGE =====================
  function handleMessageKeydown(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendMessageHandler();
    }
  }
  
  async function sendMessageHandler() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text || !currentChat) return;
    
    // Optimistic update
    const tempMsg = {
      id: Date.now(),
      chatId: currentChat.id,
      senderId: currentUser.userid,
      text: text,
      timestamp: new Date().toISOString(),
      status: 'sending'
    };
    
    currentMessages.push(tempMsg);
    renderMessages();
    input.value = '';
    
    // Send to API
    const result = await apiCall({
      action: 'sendMessage',
      chatId: currentChat.id,
      senderId: currentUser.userid,
      text: text
    });
    
    if (!result.ok) {
      showToast('خطا در ارسال پیام', true);
      // Remove failed message
      currentMessages = currentMessages.filter(m => m.id !== tempMsg.id);
      renderMessages();
    }
  }
  
  // ===================== NEW CHAT MODAL =====================
  function showNewChatModal() {
    document.getElementById('newChatModal').classList.remove('hidden');
    renderUsersList();
  }
  
  function closeNewChatModal() {
    document.getElementById('newChatModal').classList.add('hidden');
  }
  
  function switchNewTab(tab) {
    const tabs = ['user', 'group', 'channel'];
    tabs.forEach(t => {
      document.getElementById(`newTab${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.remove('text-indigo-400', 'border-indigo-400');
      document.getElementById(`newTab${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.add('text-gray-400', 'border-transparent');
      document.getElementById(`new${t.charAt(0).toUpperCase() + t.slice(1)}Panel`).classList.add('hidden');
    });
    
    document.getElementById(`newTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.add('text-indigo-400', 'border-indigo-400');
    document.getElementById(`newTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('text-gray-400', 'border-transparent');
    document.getElementById(`new${tab.charAt(0).toUpperCase() + tab.slice(1)}Panel`).classList.remove('hidden');
  }
  
  function renderUsersList() {
    const container = document.getElementById('usersList');
    
    if (allUsers.length === 0) {
      container.innerHTML = '<div class="text-center py-8 text-gray-400">کاربری یافت نشد</div>';
      return;
    }
    
    container.innerHTML = allUsers.map(user => `
      <div onclick="startNewChat('${user.userid}')" class="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-xl cursor-pointer transition">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
          ${user.username.charAt(0).toUpperCase()}
        </div>
        <div class="flex-1">
          <p class="font-medium text-white">${user.username}</p>
          <p class="text-sm text-gray-400">@${user.userid}</p>
        </div>
        <div class="w-2 h-2 rounded-full ${user.online ? 'bg-green-400' : 'bg-gray-500'}"></div>
      </div>
    `).join('');
  }
  
  function searchUsers() {
    const query = document.getElementById('userSearchInput').value.toLowerCase();
    const filtered = allUsers.filter(u => 
      u.username.toLowerCase().includes(query) || 
      u.userid.toLowerCase().includes(query)
    );
    
    const container = document.getElementById('usersList');
    
    if (filtered.length === 0) {
      container.innerHTML = '<div class="text-center py-8 text-gray-400">کاربری یافت نشد</div>';
      return;
    }
    
    container.innerHTML = filtered.map(user => `
      <div onclick="startNewChat('${user.userid}')" class="flex items-center gap-3 p-3 hover:bg-gray-700 rounded-xl cursor-pointer transition">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
          ${user.username.charAt(0).toUpperCase()}
        </div>
        <div class="flex-1">
          <p class="font-medium text-white">${user.username}</p>
          <p class="text-sm text-gray-400">@${user.userid}</p>
        </div>
      </div>
    `).join('');
  }
  
  async function startNewChat(targetId) {
    closeNewChatModal();
    showToast('در حال ایجاد چت...');
    
    const result = await apiCall({
      action: 'startChat',
      oderId: currentUser.userid,
      targetId: targetId
    });
    
    if (result.ok) {
      await loadChats();
      if (result.chat) {
        openChat(result.chat.id);
      }
      showToast('چت ایجاد شد!');
    } else {
      showToast(result.error || 'خطا در ایجاد چت', true);
    }
  }
  
  async function createNewGroup() {
    const name = document.getElementById('newGroupName').value.trim();
    const bio = document.getElementById('newGroupBio').value.trim();
    
    if (!name) {
      showToast('نام گروه را وارد کنید', true);
      return;
    }
    
    closeNewChatModal();
    showToast('در حال ساخت گروه...');
    
    const result = await apiCall({
      action: 'createGroup',
      name: name,
      bio: bio,
      owner: currentUser.userid
    });
    
    if (result.ok) {
      await loadGroups();
      showToast('گروه ساخته شد!');
      document.getElementById('newGroupName').value = '';
      document.getElementById('newGroupBio').value = '';
    } else {
      showToast(result.error || 'خطا در ساخت گروه', true);
    }
  }
  
  async function createNewChannel() {
    const name = document.getElementById('newChannelName').value.trim();
    const bio = document.getElementById('newChannelBio').value.trim();
    
    if (!name) {
      showToast('نام کانال را وارد کنید', true);
      return;
    }
    
    closeNewChatModal();
    showToast('در حال ساخت کانال...');
    
    const result = await apiCall({
      action: 'createChannel',
      name: name,
      bio: bio,
      owner: currentUser.userid
    });
    
    if (result.ok) {
      await loadChannels();
      showToast('کانال ساخته شد!');
      document.getElementById('newChannelName').value = '';
      document.getElementById('newChannelBio').value = '';
    } else {
      showToast(result.error || 'خطا در ساخت کانال', true);
    }
  }
  
  // ===================== FILTER CHATS =====================
  function filterChats() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('#chatsContainer .sidebar-item');
    
    items.forEach(item => {
      const name = item.querySelector('.font-medium').textContent.toLowerCase();
      item.style.display = name.includes(query) ? 'flex' : 'none';
    });
  }
  
  // ===================== POLLING =====================
  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    
    pollInterval = setInterval(async () => {
      if (currentChat) {
        const result = await apiCall({ action: 'getMessages', chatId: currentChat.id });
        if (result.ok && result.messages) {
          if (result.messages.length !== currentMessages.length) {
            currentMessages = result.messages;
            renderMessages();
          }
        }
      }
      
      // Also refresh chat list
      await loadChats();
    }, 5000);
  }
  
  // ===================== HELPERS =====================
  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    
    if (date.toDateString() === now.toDateString()) {
      return date.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
    }
    
    return date.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' });
  }
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function closeChatMobile() {
    document.getElementById('chatView').classList.add('hidden');
    document.getElementById('emptyState').classList.remove('hidden');
    currentChat = null;
    renderChatList();
  }
  
  // ===================== INIT =====================
  document.addEventListener('DOMContentLoaded', () => {
    // Check for saved session
    const savedUser = localStorage.getItem('patronus_user');
    if (savedUser) {
      try {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      } catch (e) {
        localStorage.removeItem('patronus_user');
      }
    }
  });
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b30f519d44bdcc9',t:'MTc2NjU4ODMxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>