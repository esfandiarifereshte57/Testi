<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AcioAI Chat</title>
<style>
  /* ----------------------------
     CSS Ú©Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ø§Ù†Øªâ€ŒØ§Ù†Ø¯
     Ø´Ø§Ù…Ù„ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ÛŒÛŒØŒ Ø§Ø³ØªØ§ÛŒÙ„ Ú†ØªØŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯
  ---------------------------- */
  body { margin:0; font-family: "Vazir", sans-serif; background:#f0f2f5; }
  #chat-container { max-width:800px; margin:50px auto; background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); overflow:hidden; display:flex; flex-direction:column; height:90vh; }
  #messages { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
  .message { max-width:70%; padding:10px 15px; border-radius:15px; word-break:break-word; position:relative; }
  .user { align-self:flex-end; background:#007bff; color:#fff; }
  .ai { align-self:flex-start; background:#e4e6eb; color:#000; }
  .typing { font-style:italic; opacity:0.7; }
  .message-icons { position:absolute; bottom:5px; right:5px; display:flex; gap:5px; }
  .icon-btn { cursor:pointer; font-size:14px; opacity:0.6; transition:0.2s; }
  .icon-btn:hover { opacity:1; }
  #input-container { display:flex; padding:10px; border-top:1px solid #ccc; gap:5px; }
  #user-input { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; }
  #send-btn, #voice-btn { padding:10px 15px; border:none; border-radius:50%; background:#007bff; color:#fff; cursor:pointer; }
  #send-btn:hover, #voice-btn:hover { background:#0056b3; }
  @media(max-width:600px) {
    #chat-container { height:95vh; margin:20px; }
    .message { max-width:85%; }
  }
</style>
</head>
<body>

<div id="chat-container">
  <div id="messages"></div>
  <div id="input-container">
    <input id="user-input" type="text" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
    <button id="voice-btn">ğŸ¤</button>
    <button id="send-btn">â¤</button>
  </div>
</div>

<script>
  /* ----------------------------
     JS Ø¨Ø±Ø§ÛŒ Ú†Øª Ù…ØªÙ†ÛŒØŒ ØµÙˆØªÛŒØŒ ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯ØŒ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§
     Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÙˆØ¨ Ø§Ù¾: https://script.google.com/macros/s/AKfycbyTa1I8tkiffVbsLNIl4gvigHlQkKa9dXWaxLYKJpqVuE72TDMZ0YwNMga93JX6gbAj/exec
  ---------------------------- */

  const API_URL = "https://script.google.com/macros/s/AKfycbyTa1I8tkiffVbsLNIl4gvigHlQkKa9dXWaxLYKJpqVuE72TDMZ0YwNMga93JX6gbAj/exec";
  const messagesEl = document.getElementById("messages");
  const inputEl = document.getElementById("user-input");
  const sendBtn = document.getElementById("send-btn");
  const voiceBtn = document.getElementById("voice-btn");

  let userId = null; // Ù¾Ø³ Ø§Ø² Ø«Ø¨Øª Ù†Ø§Ù…/ÙˆØ±ÙˆØ¯ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯

  /* ----------------------------
     Ø§ÙØ²ÙˆØ¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØµÙØ­Ù‡
  ---------------------------- */
  function addMessage(text, type="ai", audioUrl=null) {
    const div = document.createElement("div");
    div.className = `message ${type}`;
    div.innerHTML = text;

    if(type==="ai") {
      const icons = document.createElement("div");
      icons.className = "message-icons";

      const copyBtn = document.createElement("span");
      copyBtn.className="icon-btn";
      copyBtn.innerText="ğŸ“‹";
      copyBtn.onclick = () => navigator.clipboard.writeText(text);

      const audioBtn = document.createElement("span");
      audioBtn.className="icon-btn";
      audioBtn.innerText="ğŸ”Š";
      audioBtn.onclick = () => {
        if(audioUrl) new Audio(audioUrl).play();
      }

      icons.appendChild(copyBtn);
      icons.appendChild(audioBtn);
      div.appendChild(icons);
    }

    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  /* ----------------------------
     ØªØ§ÛŒÙ¾ÛŒÙ†Ú¯ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ AI
  ---------------------------- */
  function typingAI(message, audioUrl=null) {
    const div = document.createElement("div");
    div.className="message ai typing";
    div.innerText="Ø¯Ø± Ø­Ø§Ù„ ØªØ§ÛŒÙ¾...";
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;

    setTimeout(()=>{
      div.className="message ai";
      div.innerText=message;
      if(audioUrl){
        const icons = document.createElement("div");
        icons.className="message-icons";
        const copyBtn = document.createElement("span");
        copyBtn.className="icon-btn";
        copyBtn.innerText="ğŸ“‹";
        copyBtn.onclick = () => navigator.clipboard.writeText(message);
        const audioBtn = document.createElement("span");
        audioBtn.className="icon-btn";
        audioBtn.innerText="ğŸ”Š";
        audioBtn.onclick = () => new Audio(audioUrl).play();
        icons.appendChild(copyBtn);
        icons.appendChild(audioBtn);
        div.appendChild(icons);
      }
    }, 1000 + Math.random()*1000);
  }

  /* ----------------------------
     Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ÙˆØ¨ Ø§Ù¾
  ---------------------------- */
  async function sendMessage(text) {
    if(!userId){ alert("Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯"); return; }
    addMessage(text,"user");
    inputEl.value="";

    try {
      const resp = await fetch(API_URL, {
        method:"POST",
        headers: { "Content-Type":"application/x-www-form-urlencoded" },
        body: new URLSearchParams({
          action:"chat",
          userid:userId,
          text:text
        })
      });
      const data = await resp.json();
      if(data.ok){
        let audioUrl=null;
        // ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ø¨Ù‡ ØµØ¯Ø§ Ø¨Ø§ ÙˆØ¨ Ø³Ø±ÙˆÛŒØ³ Hakhamanesh
        const voiceResp = await fetch(`https://hakhamanesh-bot.ir/api/voice?text=${encodeURIComponent(data.Result)}`);
        const voiceData = await voiceResp.json();
        if(voiceData.ok) audioUrl = voiceData.audio_url;
        typingAI(data.Result, audioUrl);
      } else {
        typingAI("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: "+data.error);
      }
    } catch(err){
      typingAI("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
      console.error(err);
    }
  }

  /* ----------------------------
     Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
  ---------------------------- */
  sendBtn.onclick = () => { 
    const text = inputEl.value.trim();
    if(text) sendMessage(text);
  }

  inputEl.addEventListener("keypress", e=>{
    if(e.key==="Enter") sendBtn.click();
  });

  /* ----------------------------
     Ú†Øª ØµÙˆØªÛŒ Ú©Ø§Ø±Ø¨Ø±
  ---------------------------- */
  let recognition=null;
  if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang="fa-IR";
    recognition.continuous=false;
    recognition.interimResults=false;

    recognition.onresult = (event)=>{
      const speech = event.results[0][0].transcript;
      inputEl.value = speech;
      sendBtn.click();
    }

    recognition.onerror = (event)=>{
      console.error("Speech Recognition Error:", event.error);
    }

    voiceBtn.onclick = ()=> recognition.start();
  } else {
    voiceBtn.onclick = ()=> alert("Ú†Øª ØµÙˆØªÛŒ ÙÙ‚Ø· Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù…Ø¯Ø±Ù† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯");
  }

  /* ----------------------------
     ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù… Ø³Ø±ÛŒØ¹ (ÙÙ‚Ø· Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ù†Ø§Ù…)
  ---------------------------- */
  async function register(name,email){
    const resp = await fetch(API_URL+"?action=register&name="+encodeURIComponent(name)+"&email="+encodeURIComponent(email));
    const data = await resp.json();
    if(data.ok){ userId=data.Result.userId; alert("Ø«Ø¨Øª Ù†Ø§Ù… Ù…ÙˆÙÙ‚"); }
    else alert("Ø®Ø·Ø§: "+data.error);
  }

  async function login(email){
    const resp = await fetch(API_URL+"?action=login&email="+encodeURIComponent(email));
    const data = await resp.json();
    if(data.ok){ userId=data.Result.userId; alert("ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚"); }
    else alert("Ø®Ø·Ø§: "+data.error);
  }

  /* ----------------------------
     Ù…Ø«Ø§Ù„ Ø³Ø±ÛŒØ¹: Ø«Ø¨Øª Ù†Ø§Ù… ÛŒØ§ ÙˆØ±ÙˆØ¯
  ---------------------------- */
  (async ()=>{
    let name = prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    let email = prompt("Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    const user = confirm("Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒØ¯ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯ØŸ OK=Ø«Ø¨Øª Ù†Ø§Ù…, Cancel=ÙˆØ±ÙˆØ¯");
    if(user) await register(name,email);
    else await login(email);
  })();
</script>

</body>
</html>